# 需求完善总结

## 原始需求回顾

用户原始需求：
- 本地音乐播放器
- 扫描手机 SD 卡中的音频文件
- 列表显示歌曲
- 点击歌曲后，将当前列表添加到播放列表并播放当前歌曲
- 使用 Media3 1.9.0 库
- 在系统媒体中心和通知栏显示播放控制
- **补充需求**: 用户可能对某些本地音频比较喜欢，需要添加收藏列表歌曲。可以在列表中、播放页中、系统媒体通知栏中快速收藏/取消收藏。收藏的数据可使用 room 数据库进行本地保存

## 需求完善内容

作为产品经理，我对原始需求进行了以下完善和细化：

### 1. 功能范围明确化

#### 1.1 音频文件扫描功能
**原始需求**: "扫描手机 sdcard 中可以播放音频文件"

**完善后**:
- ✅ 明确支持格式：MP3、AAC、FLAC、WAV、OGG、M4A
- ✅ 扫描范围：不仅限于 SD 卡，还包括内部存储
- ✅ 递归扫描子目录
- ✅ 提取音频元数据（标题、艺术家、专辑、时长、封面）
- ✅ 后台异步扫描，显示进度
- ✅ 扫描结果缓存机制

#### 1.2 歌曲列表展示功能
**原始需求**: "列表显示歌曲"

**完善后**:
- ✅ 列表项显示信息：标题、艺术家、时长、封面（可选）
- ✅ 支持列表滚动和快速定位
- ✅ 点击交互反馈
- ✅ 加载状态提示

#### 1.3 播放功能
**原始需求**: "点击歌曲后，将当前列表添加到播放列表并播放当前歌曲"

**完善后**:
- ✅ 点击歌曲立即播放（延迟 < 500ms）
- ✅ 自动将当前列表添加到播放队列
- ✅ 播放当前选中的歌曲
- ✅ 支持播放/暂停控制
- ✅ 支持上一首/下一首切换
- ✅ 显示播放进度和总时长
- ✅ 支持进度条拖拽跳转
- ✅ 前台服务支持后台播放

#### 1.4 系统媒体集成
**原始需求**: "在系统媒体中心和通知栏显示播放控制"

**完善后**:
- ✅ 系统媒体中心显示播放信息和控制
- ✅ 通知栏显示播放通知，包含：
  - 歌曲标题和艺术家
  - 播放/暂停按钮
  - 上一首/下一首按钮
  - 关闭按钮
- ✅ 锁屏界面显示播放控制
- ✅ 支持蓝牙设备媒体控制
- ✅ 支持 Android Auto（如果设备支持）

#### 1.5 收藏功能（新增）
**补充需求**: "用户可能对某些本地音频比较喜欢，需要添加收藏列表歌曲。可以在列表中、播放页中、系统媒体通知栏中快速收藏/取消收藏。收藏的数据可使用 room 数据库进行本地保存"

**完善后**:
- ✅ 用户可以在歌曲列表中点击收藏按钮收藏/取消收藏
- ✅ 用户可以在播放页面中点击收藏按钮收藏/取消收藏
- ✅ 用户可以在系统媒体通知栏中点击收藏按钮收藏/取消收藏
- ✅ 收藏状态在所有界面实时同步显示
- ✅ 使用 Room 数据库持久化保存收藏数据
- ✅ 应用重启后收藏状态正确恢复
- ✅ 收藏按钮有明确的视觉反馈（已收藏/未收藏状态）
- ✅ 收藏操作响应时间 < 200ms

### 2. 非功能性需求补充

#### 2.1 性能要求
- 扫描 1000 首歌曲的时间 < 30 秒
- 播放启动延迟 < 500ms
- UI 帧率保持 60fps
- 内存占用 < 150MB（不含音频缓冲）

#### 2.2 用户体验要求
- 遵循 Material Design 3 设计规范
- 提供清晰的加载状态反馈
- 友好的错误提示
- 支持深色模式

#### 2.3 无障碍性要求
- 支持 TalkBack 屏幕阅读器
- 符合最小触摸目标尺寸（48dp）
- 支持系统字体缩放

#### 2.4 稳定性要求
- 扫描成功率 > 99%
- 播放成功率 > 99.5%
- 崩溃率 < 0.1%

### 3. 技术架构明确

#### 3.1 架构模式
- MVVM（Model-View-ViewModel）
- 分层架构：UI 层、ViewModel 层、Repository 层、Data 层

#### 3.2 核心技术栈
- **语言**: Kotlin
- **播放引擎**: Media3 1.9.0
- **异步处理**: Kotlin Coroutines + Flow
- **UI 框架**: 初期使用传统 View 系统
- **依赖注入**: 考虑使用 Hilt（可选）

#### 3.3 Media3 依赖
- `androidx.media3:media3-exoplayer:1.9.0`
- `androidx.media3:media3-ui:1.9.0`
- `androidx.media3:media3-session:1.9.0`
- `androidx.media3:media3-common:1.9.0`

#### 3.4 Room 数据库依赖（新增）
- `androidx.room:room-runtime`
- `androidx.room:room-ktx`
- `androidx.room:room-compiler` (使用 ksp 或 kapt)

### 4. 权限和兼容性

#### 4.1 所需权限
- `READ_EXTERNAL_STORAGE`（Android 12 及以下）
- `READ_MEDIA_AUDIO`（Android 13+）
- `FOREGROUND_SERVICE`（播放服务）
- `POST_NOTIFICATIONS`（Android 13+）

#### 4.2 兼容性
- 最低 SDK: Android 7.0 (API 24)
- 目标 SDK: Android 14 (API 36)
- 支持 Android 13+ 分区存储

### 5. 范围边界明确

#### 5.1 范围内功能（v1.0）
- ✅ 音频文件扫描
- ✅ 歌曲列表展示
- ✅ 基础播放控制
- ✅ 系统媒体通知集成
- ✅ 播放队列管理（自动添加当前列表）
- ✅ 收藏功能（列表、播放页、通知栏三处支持）

#### 5.2 范围外功能（未来版本）
- ❌ 播放列表创建和管理（用户自定义）
- ❌ 歌曲搜索和筛选
- ❌ 音频均衡器和音效处理
- ❌ 歌词显示
- ❌ 音乐标签编辑
- ❌ 在线音乐流媒体
- ❌ 音频可视化

### 6. 用户故事细化

将需求拆分为 6 个独立的用户故事（Story 详细文档需在 Feature PRD 批准后创建）：
1. **STORY-001**: 音频文件扫描
2. **STORY-002**: 歌曲列表展示
3. **STORY-003**: 音乐播放与队列管理
4. **STORY-004**: Media3 播放引擎集成
5. **STORY-005**: 系统媒体通知集成
6. **STORY-006**: 收藏功能（新增，待 Feature PRD 批准后创建详细文档）

### 7. 关键设计决策

#### 7.1 播放队列策略
- **决策**: 点击歌曲时，自动将当前列表添加到播放队列
- **理由**: 简化用户操作，符合用户预期
- **实现**: 使用 Media3 的 MediaQueue 功能

#### 7.2 扫描策略
- **决策**: 首次启动自动扫描，支持手动刷新
- **理由**: 减少用户等待，提供控制权
- **实现**: 后台异步扫描，结果缓存

#### 7.3 服务架构
- **决策**: 使用前台服务运行播放器
- **理由**: 确保后台播放稳定性，符合 Android 后台限制
- **实现**: MediaSessionService + ForegroundService

#### 7.4 收藏数据存储（新增）
- **决策**: 使用 Room 数据库存储收藏数据
- **理由**: Room 是 Android 官方推荐的数据库解决方案，类型安全、易于测试、支持 Flow
- **实现**: FavoriteEntity + FavoriteDao + FavoriteRepository

## 完善后的完整需求文档

所有完善后的需求已记录在以下文档中：

1. **项目概览**: `.ai/prd/index.md`
2. **整体愿景**: `.ai/prd/APP-Overall-Vision.md`
3. **功能 PRD**: `.ai/prd/features/local-music-player/index.md`

## 下一步行动

1. ✅ 需求完善完成（包含收藏功能）
2. ✅ 创建收藏功能 Story 文档（STORY-006）
3. ⏳ 等待需求评审和批准
4. ⏳ 创建其他 Story 详细文档
5. ⏳ 进行架构设计
6. ⏳ 开始开发实施

## 需要确认的问题

1. **播放模式**: v1.0 是否需要支持单曲循环、随机播放等模式？
   - 建议：v1.0 仅支持顺序播放，后续版本添加

2. **扫描范围**: 是否允许用户选择特定目录扫描？
   - 建议：v1.0 扫描所有可访问目录，后续版本添加选择功能

3. **播放界面**: 是否需要独立的播放界面，还是仅通过通知控制？
   - 建议：v1.0 提供简单的播放控制界面，后续版本优化

4. **错误处理**: 扫描到损坏的音频文件如何处理？
   - 建议：跳过损坏文件，记录日志，不影响整体扫描

5. **收藏列表界面**: v1.0 是否需要独立的收藏列表查看界面？
   - 建议：v1.0 仅支持收藏状态显示和操作，收藏列表查看功能可在后续版本添加

---

**文档创建时间**: 2025-01-27  
**最后更新**: 2025-01-27（添加收藏功能）  
**状态**: 待评审
