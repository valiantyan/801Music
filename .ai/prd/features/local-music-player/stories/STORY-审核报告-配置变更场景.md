# Story 审核报告：配置变更场景处理

**审核日期**: 2025-01-27  
**审核范围**: `.ai/prd/features/local-music-player/stories/` 目录下所有 Story  
**审核重点**: 系统主题切换、屏幕旋转、分屏等配置变更场景的处理

---

## 执行摘要

本次审核发现，**所有6个Story均未明确考虑配置变更场景**（系统主题切换、屏幕旋转、分屏等）。虽然架构文档提到 ViewModel 会自动处理配置变更，但 Fragment 层面的状态保存和恢复仍需明确设计和测试。

### 关键发现

1. ❌ **验收标准缺失**: 所有 Story 的验收标准中都没有配置变更相关的测试要求
2. ❌ **测试用例缺失**: 开发步骤中没有包含配置变更场景的测试用例
3. ⚠️ **技术设计不完整**: 技术设计部分没有明确说明状态保存和恢复策略
4. ✅ **架构基础良好**: ViewModel 使用 StateFlow，理论上可以自动处理配置变更

---

## 详细审核结果

### STORY-001: 音频文件扫描

**当前状态**: ⚠️ 部分考虑

**问题**:
- ❌ 验收标准中没有配置变更测试要求
- ❌ 测试用例中没有屏幕旋转、主题切换等场景
- ❌ 没有说明扫描进度状态在配置变更时的保存策略

**需要补充**:
- ✅ 扫描进度 Fragment 的状态保存（当前扫描路径、已扫描数量）
- ✅ 扫描过程中配置变更不应中断扫描任务
- ✅ 配置变更后 UI 应正确恢复扫描进度显示

**影响**: 中等 - 扫描过程中如果发生配置变更，用户可能看不到正确的进度信息

---

### STORY-002: 歌曲列表展示

**当前状态**: ❌ 未考虑

**问题**:
- ❌ 验收标准中没有配置变更测试要求
- ❌ 测试用例中没有列表滚动位置保存测试
- ❌ 没有说明 RecyclerView 状态保存策略

**需要补充**:
- ✅ RecyclerView 滚动位置保存和恢复
- ✅ 列表选中项状态保存（如果有）
- ✅ 深色/浅色主题切换时 UI 正确适配
- ✅ 分屏模式下列表布局正确显示

**影响**: 高 - 用户滚动列表后旋转屏幕，滚动位置丢失，体验很差

---

### STORY-003: 音乐播放与队列管理

**当前状态**: ❌ 未考虑

**问题**:
- ❌ 验收标准中没有配置变更测试要求
- ❌ 测试用例中没有播放状态保存测试
- ❌ 没有说明播放进度、队列状态在配置变更时的保存策略

**需要补充**:
- ✅ 播放状态通过 ViewModel 自动保存（已由架构保证）
- ✅ 播放进度条位置保存（如果用户正在拖拽）
- ✅ 播放队列状态保存
- ✅ 配置变更后播放不应中断（通过 Service 保证）
- ✅ 分屏模式下播放控制界面正确显示

**影响**: 高 - 播放过程中配置变更，如果状态未正确保存，用户需要重新选择歌曲

---

### STORY-004: Media3 播放引擎集成

**当前状态**: ⚠️ 部分考虑

**问题**:
- ❌ 验收标准中没有配置变更测试要求
- ❌ 测试用例中没有播放器生命周期在配置变更时的测试
- ⚠️ 技术设计提到"播放器资源正确管理"，但没有明确配置变更场景

**需要补充**:
- ✅ 播放器实例不应在配置变更时重建（应使用单例或 Service）
- ✅ 播放状态通过 MediaSession 持久化（已由架构保证）
- ✅ 配置变更时播放不应中断

**影响**: 中等 - 如果播放器在配置变更时重建，可能导致播放中断

---

### STORY-005: 系统媒体通知集成

**当前状态**: ✅ 影响较小

**问题**:
- ❌ 验收标准中没有配置变更测试要求
- ⚠️ 通知栏功能主要通过 Service 实现，受配置变更影响较小

**需要补充**:
- ✅ 配置变更时通知栏应继续正常工作
- ✅ 主题切换时通知栏样式正确适配

**影响**: 低 - Service 不受配置变更影响，但通知栏样式需要考虑主题适配

---

### STORY-006: 收藏功能

**当前状态**: ⚠️ 部分考虑

**问题**:
- ❌ 验收标准中没有配置变更测试要求
- ❌ 测试用例中没有收藏状态在配置变更时的测试
- ⚠️ 收藏数据通过数据库持久化，但 UI 状态仍需考虑

**需要补充**:
- ✅ 收藏状态通过数据库持久化（已实现）
- ✅ 配置变更后收藏状态 UI 应正确恢复
- ✅ 收藏按钮状态在配置变更时不应丢失

**影响**: 中等 - 收藏数据已持久化，但 UI 状态恢复需要确保

---

## 配置变更场景清单

### 1. 屏幕旋转 (Screen Rotation)
- **触发**: 设备从竖屏旋转到横屏，或反之
- **影响**: Activity 和 Fragment 会重建
- **需要保存的状态**:
  - RecyclerView 滚动位置
  - 对话框/底部表单状态
  - 输入框内容（如果有）
  - 播放进度条拖拽状态

### 2. 系统主题切换 (Theme Switching)
- **触发**: 用户在系统设置中切换深色/浅色主题
- **影响**: Activity 和 Fragment 会重建
- **需要保存的状态**:
  - 所有 UI 状态（通过 ViewModel 自动保存）
  - 确保主题资源正确应用

### 3. 分屏模式 (Multi-Window)
- **触发**: 用户进入分屏模式
- **影响**: Activity 和 Fragment 会重建
- **需要保存的状态**:
  - 所有 UI 状态
  - 布局适配（确保在小窗口下正确显示）

### 4. 语言切换 (Locale Change)
- **触发**: 用户切换系统语言
- **影响**: Activity 和 Fragment 会重建
- **需要保存的状态**:
  - 所有 UI 状态
  - 确保字符串资源正确更新

### 5. 字体大小调整 (Font Scale)
- **触发**: 用户在系统设置中调整字体大小
- **影响**: Activity 和 Fragment 会重建
- **需要保存的状态**:
  - 所有 UI 状态
  - 确保布局正确适配新字体大小

---

## 推荐解决方案

### 1. ViewModel 状态管理（已由架构保证）
- ✅ ViewModel 在配置变更时不会重建
- ✅ StateFlow 状态自动保持
- ✅ 这是主要的状态保存机制

### 2. Fragment 视图状态保存
- ✅ 使用 `onSaveInstanceState()` 保存视图状态
- ✅ RecyclerView 使用 `LinearLayoutManager.onSaveInstanceState()`
- ✅ 自定义视图状态保存（如播放进度条拖拽状态）

### 3. Navigation 状态保存
- ✅ Navigation Component 自动保存导航状态
- ✅ Safe Args 参数在配置变更时保持

### 4. 测试策略
- ✅ 每个 Story 添加配置变更测试用例
- ✅ 使用 `ActivityScenario` 或 `FragmentScenario` 测试配置变更
- ✅ 验证状态恢复的正确性

---

## 行动计划

### 立即行动（高优先级）

1. **更新所有 Story 的验收标准**
   - 添加配置变更相关的 AC
   - 明确状态保存和恢复要求

2. **更新所有 Story 的测试用例**
   - 添加屏幕旋转测试
   - 添加主题切换测试
   - 添加分屏模式测试

3. **更新技术设计**
   - 明确状态保存策略
   - 说明 Fragment 视图状态保存方法

### 后续优化（中优先级）

1. **创建配置变更测试模板**
   - 统一测试方法
   - 可复用的测试工具类

2. **文档化最佳实践**
   - Fragment 状态保存指南
   - ViewModel 使用规范

---

## 结论

虽然项目架构（ViewModel + StateFlow）已经为配置变更提供了良好的基础，但**所有 Story 都需要补充配置变更场景的明确设计和测试**。建议立即更新所有 Story 文档，确保配置变更场景得到充分考虑。

**优先级**: 🔴 高 - 配置变更处理是 Android 应用的基本要求，必须在开发阶段就考虑
