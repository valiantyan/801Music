# 架构设计总结

## 文档创建时间
2025-01-27

## 架构文档位置
`.ai/architecture/arch-overview.md`

## 核心架构决策

### 1. 架构模式
- **MVVM (Model-View-ViewModel)**: 分离 UI 逻辑和业务逻辑
- **Repository Pattern**: 统一数据访问接口
- **单一数据源**: Repository 作为唯一数据源

### 2. 技术栈选型

#### 核心库
- **播放引擎**: Media3 ExoPlayer 1.9.0
- **数据库**: Room (SQLite)
- **异步编程**: Kotlin Coroutines + Flow
- **UI 框架**: Android XML Layout (v1.0)
- **依赖注入**: 手动注入 (v1.0，未来可迁移到 Hilt)

#### 关键依赖
- `androidx.media3:media3-exoplayer:1.9.0`
- `androidx.media3:media3-session:1.9.0`
- `androidx.room:room-runtime`
- `androidx.room:room-ktx`
- `androidx.lifecycle:lifecycle-viewmodel-ktx`

### 3. 分层架构

```
表现层 (UI)
    ↓
ViewModel 层
    ↓
领域层 (Domain)
    ↓
数据层 (Repository)
    ↓
数据源 (Room DB / File System / Media3)
```

### 4. 核心模块设计

#### 4.1 播放器模块
- `MediaPlayerManager`: Media3 ExoPlayer 封装
- `PlaybackController`: 播放控制
- `MediaQueueManager`: 播放队列管理

#### 4.2 数据层
- `AudioRepository`: 音频文件扫描和元数据
- `FavoriteRepository`: 收藏数据管理
- `PlayerRepository`: 播放状态管理
- `Room Database`: 收藏数据持久化

#### 4.3 服务层
- `MediaSessionService`: 媒体会话服务
- `PlayerNotificationManager`: 通知栏管理

### 5. 数据流设计

#### 状态管理
- **ViewModel**: 使用 `StateFlow<UiState>` 管理 UI 状态
- **Repository**: 使用 `Flow<T>` 暴露数据变化
- **单向数据流**: UI → ViewModel → Repository → DataSource

#### 关键数据流场景
1. **扫描音频**: 用户触发 → ViewModel → Repository → FileSystem → Flow<Progress> → UI 更新
2. **播放歌曲**: 用户点击 → ViewModel → PlayerRepository → Media3Player → Flow<State> → UI 更新
3. **收藏操作**: 用户点击 → ViewModel → FavoriteRepository → Room DB → Flow<Boolean> → UI 更新

### 6. 项目结构

```
com.valiantyan.aidemo/
├── ui/              # UI 层 (Activity, Fragment, Adapter)
├── viewmodel/       # ViewModel 层
├── domain/          # 领域层 (Model, UseCase)
├── data/            # 数据层 (Repository, Database, DataSource)
├── player/          # 播放器模块 (Media3 封装)
├── service/         # 服务层 (MediaSessionService)
└── di/              # 依赖注入
```

### 7. 非功能性需求 (NFRs)

#### 性能指标
- 播放启动延迟: < 500ms
- UI 帧率: 60fps
- 扫描性能: 1000 首歌曲 < 30 秒
- 内存占用: < 150MB

#### 其他 NFRs
- **电池效率**: 前台服务优化，最小化唤醒锁
- **离线支持**: 完全离线，Room 数据库持久化
- **安全性**: 权限最小化，代码混淆
- **可测试性**: 分层架构，支持 Mock
- **无障碍性**: TalkBack 支持，触摸目标 48dp

### 8. 关键设计要点

1. **响应式编程**: 使用 Flow 实现数据流的自动更新
2. **单一数据源**: Repository 作为唯一数据源，避免数据不一致
3. **服务集成**: MediaSessionService 实现系统级媒体控制
4. **状态同步**: 收藏状态在列表、播放页、通知栏三处实时同步
5. **可扩展性**: 模块化设计，便于未来功能扩展

## 架构文档状态

- **状态**: 草稿
- **下一步**: 等待评审和批准

## 相关文档链接

- **架构文档**: `.ai/architecture/arch-overview.md`
- **PRD 索引**: `.ai/prd/index.md`
- **整体愿景**: `.ai/prd/APP-Overall-Vision.md`
- **功能 PRD**: `.ai/prd/features/local-music-player/index.md`

## 待确认事项

1. 架构模式是否符合项目需求？
2. 技术选型是否合理？
3. 模块划分是否清晰？
4. 数据流设计是否满足性能要求？

---

**创建者**: AI Agent  
**最后更新**: 2025-01-27
